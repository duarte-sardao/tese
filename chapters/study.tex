\chapter{Empirical methodology}\label{chap:study}

The purpose of this chapter of work was to assess the capabilities of LLM to identify and test semantic conflicts.
Thus, it was divided into two phases: an initial exploratory phase, where an unstructured exploration allowed us to develop prompts, identify characteristics of the LLM and narrow down on its abilities and limitations.
In a second phase, work was systematized, with the elaboration of research questions and metrics to evaluate results.

\section{Experimental subjects}\label{chap:study:subjects}

To assess the validity of a developed solution, a collection of subjects to test must be collected. While several previous work has compiled collections of merge commits with semantic conflicts, the collection done by \citet{kn:nuno} is particularly useful, being publicly available, closely related to our own work, and also allowing us to draw direct comparisons. Most importantly, it aggregates merge instances from both \citet{kn:leuson} and \citet{kn:safemerge}, while also providing valuable information, due to the work developed, such as the specific type of conflict present and whether it was detected and correctly tested by UNSETTLE (providing us with a ``base truth''). Furthermore, it has compiled a set of fabricated conflicts, which provide simpler isolated examples that can aid us as they should be easier to detect and test.
In analyzing the work of Nuno Castanho, we found the predominant types of semantic conflicts in real scenarios where "Parallel Changes in Field", "Parallel Changes in Method" and "Change Method" \citet{kn:nuno}. Using a simple Cart class as a base, 3 examples were made for these scenarios.
These Cart examples would be part of the group of subjects used to answer and evaluate the research questions we defined. These were complemented by a simple Point class, two examples fabricated by Nuno Castanho of type "Override by Access Change" and "Remove Override", which had achieved good results in exploratory testing, Antlr4 and OkHttp, respectively a simple and a hard to test real-world scenario.

\todo{In addition to the text above, I would also suggest a table with three columns:
name of the subject, whether is fabricated, and what conflict is present.  Although
the text is ok, it is not that easy to spot which subjects were used.}


\section{Large language models}

\todo{\begin{itemize}
  \item ChatGPT
  \item (if time allows) GitHub Copilot Chat on VS Code / IntelliJ IDE
\end{itemize}}

While preliminary work sought to explore ChatGPT and Llama (both CodeLlama and Llama 2), hardware constraints meant we were unable to explore Llama. \todo{why were hardware constraints a problem?} Bing AI and Bard were also considered, but they were problematic due to very stringent message size limits, in the case of Bard, and generally worse results: Bing AI, for example, could not wait for all the information to be sent, if split in more than one message and thus generated confused responses. ChatGPT, being hosted online for free and with generous message size limits, proved to be the most reliable option. Despite this, many capabalities that could prove invaluable for this work remained locked behind a premium paywall.


\section{Research questions}

\begin{itemize}
  \item[\textbf{RQ1:}] Can ChatGPT identify, understand, and explain, whether
  there is a semantic conflict in a merge commit?

  \item[\textbf{RQ2:}] \todo{???}
\end{itemize}

\section{Experimental procedure}

\subsection{RQ1}

The first research question we established sought to more systematically evaluate ChatGPT's capabilities to assess and describe semantic conflicts: "Can ChatGPT identify, understand and explain whether there is a semantic conflict in a merge commit?"
To evaluate this research question, we established 8 subjects:\todo{the subjects have already been described in \Cref{chap:study:subjects}, thus no need to describe or list them in here.}
3 fabricated scenarios, one on a Point class and 2 by \citet{kn:nuno}, that had shown success in earlier experiments.
3 fabricated scenarios on a Cart class. These represent conflicts of type Parallel Changes in Field, Parallel Changes in Method and Change Method, which were shown to be the most common in real world scenarios~\cite{kn:nuno}. Finally, 2 real world scenarios, in the Antlr and OkHttp projects.


For assessment, we established 5 metrics, with likert scales:

-A: Changes between branches correctly identified (Correct description of Version A and B)

0: Large errors in description for both branches

1: Large error in description of one branch

2: Minor insignificant errors

3: Changes correctly identified

-B: No conflict misunderstanding (Does not describe textual conflict, understand merge succeed)

0: Understands conflict as textual

1: Understands the conflict as semantic

-C: Positive response (3 types: says conflict exists/may exist/does not exist)

0: Denies existence of conflict

1: Asserts conflict is possible

2: Asserts conflict exists

-D: Origin of conflict described (What code interactions lead to altered behaviour)

0: Incorrect or non-existent explanation

1: Identifies origin of conflict, with lack of clarity or imprecisions

2: Identifies origin of conflict, with lack of confidence

3: Identifies origin of conflict

-E: Effect of conflict described (What is the result of the code interactions/expected output)

0: Result of conflict is omitted, too vague or wrong

1: Result of conflict is expressed, but with imprecisions or generically

2: Possible code outputs are expressed, with little confidence

3: Assertively points out expected outputs due to conflict

For the purposes of this research question, we settled on a final prompt:

\begin{quote}
You are a software developer that has to assess whether there is a semantic conflict in a merge commit.  Given the base version of the class, the diff from base to a version A, the diff from base to a version B and the merged version of the class, assess whether there is a semantic conflict and explain it.

Base version:
```java
```

Diff version A and the base:
```diff
```

Diff version B and the base:
```diff
```

Merge version:
```java
```

\end{quote}

For each semantic conflict example, the prompt would be submitted 3 times, allowing us to see a broader range of responses and avoiding what might be one-time flukes.

\subsection{RQ2}

\todo{Describe RQ2's prompt and metrics used}


\section{Threats to validity}

\todo{Describe any threat to our study, e.g., subjects, llms, our prompts, and
what have we done to mitigate them.}

Based on the guidelines reported by \citet{wohlin2012experimentation}, we have
taken all reasonable steps to mitigate the effect of potential threats, which
are described in detail in this section.

\subsection{Threats to construct validity}
%
\todo{Are associated with the correspondence between theory and observation.}

\subsection{Threats to internal validity}
%
\todo{Are associated with uncontrollable internal factors that may influence our results.}

\subsection{Threats to external validity}
%
\todo{Are associated with the generalization of the results reported.}
